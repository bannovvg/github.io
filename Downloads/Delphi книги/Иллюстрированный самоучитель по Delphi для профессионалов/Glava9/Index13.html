<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title>
</title>
<meta http-equiv="Content-Type" content="text/html;charset=windows-1251">
</head>
<body TEXT="#000000" BGCOLOR="#E7E3E7"  LINK="#004080" VLINK="#004080" olink="#008080">
<table COLS="3" WIDTH="16%">
<tr>
<td>
<font face="Verdana" size="3">
<a href="Index12.html">
<img SRC="Back.gif" BORDER="0">
</a>
</font>
</td>
<td WIDTH="10%">
<font face="Verdana" size="3">
<a href="../index.html">
<img SRC="Menu.gif" BORDER="0">
</a>
</font>
</td>
<td ALIGN="RIGHT">
<font face="Verdana" size="3">
<a href="Index14.html">
<img SRC="For.gif" BORDER="0">
</a>
</font>
</td>
</tr>
</table>
<P><font face="Verdana" size="3">
&nbsp;
</font ></P>
<p align="center"> <font face="Verdana" size="3"> <strong>Оповещение 
  об изменениях в файловой системе</strong> <br>
</font>
</P>
<p align="left">
<font face="Verdana" size="3">

</font ></P>
<P><font face="Verdana" size="3">
Многие программисты задавались вопросом: как получить сигнал от операционной системы о том, что в файловой системе произошли какие-то изменения? Такой вид оповещения позаимствован из ОС UNIX и теперь доступен программистам, работающим с Win32.
</font ></P>
<P><font face="Verdana" size="3">
Для организации мониторинга файловой системы нужно использовать три
функции — <font face="Verdana" size="2">      FindFirstChangeNotification,      FindNextChangeNotification</font>     И
<font face="Verdana" size="2">FinddoseChangeNotification.</font> Первая из них возвращает дескриптор объекта файлового оповещения, который можно передать в функцию ожидания. Объект активизируется тогда, когда в заданной папке произошли те или иные изменения (создание или уничтожение файла или папки, изменение прав доступа и т. д.). Вторая функция — готовит объект к реакции на следующее изменение. Наконец, с помощью третьей функции следует закрыть, ставший ненужным, объект.
</font ></P>
<P><font face="Verdana" size="3">
Так может выглядеть код метода <font face="Verdana" size="2"> Execute</font> потока, созданного для мониторинга:
</font ></P>
<blockquote>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
var DirName : string;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">...</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
procedure TSimpleThread.Execute;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;var r: Cardinal;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
fn : THandle;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
fn := FindFirstChangeNotification(pChar(DirName),True, FILE_NOTIFY_CHANGE_FILE_NAME);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
repeat</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
r := WaitForSingleObject(fn,2000);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
if r = WAIT_OBJECT_0 then Forml.UpdateList;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
if not FindNextChangeNotification(fn) then break;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
until Terminated;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
FinddoseChangeNotification (fn) ;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;end;</font>
</font ></P>
</blockquote>
<P><font face="Verdana" size="3">
На главной форме должны находиться компоненты, нужные для выбора обследуемой папки, а также компонент
<font face="Verdana" size="2">TListBox</font>, в который будут записываться имена файлов:
</font ></P>
<blockquote>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
procedure TForml.ButtonlClick(Sender: TObject);&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> var dir : string;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
if SelectDirectory(dir, [],0) then&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
Editl.Text := dir; DirName := dir;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">end;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">end;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
procedure TForml.UpdateList; var SearchRec: TSearchRec;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
ListBoxl.Clear;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
FindFirst(Editl.Text+'\*.*', faAnyFile, SearchRec);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
repeat ListBoxl.Items.Add(SearchRec.Name);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
until FindNext(SearchRec) &lt;&gt; 0;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">FindClose(SearchRec);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;end;</font>
</font ></P>
</blockquote>
<P><font face="Verdana" size="3">
Приложение готово. Чтобы оно стало полнофункциональным, предусмотрите в нем механизм перезапуска потока при изменении обследуемой папки.
</font ></P>


<P><font face="Verdana" size="3">
&nbsp;
</font ></P>
<table COLS="3" WIDTH="16%">
<tr>
<td>
<font face="Verdana" size="3">
<a href="Index12.html">
<img SRC="Back.gif" BORDER="0">
</a>
</font>
</td>
<td WIDTH="10%">
<font face="Verdana" size="3">
<a href="../index.html">
<img SRC="Menu.gif" BORDER="0">
</a>
</font>
</td>
<td ALIGN="RIGHT">
<font face="Verdana" size="3">
<a href="Index14.html">
<img SRC="For.gif" BORDER="0">
</a>
</font>
</td>
</tr>
</table>
</body>
</html>
