<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title>
</title>
<meta http-equiv="Content-Type" content="text/html;charset=windows-1251">
</head>
<body TEXT="#000000" BGCOLOR="#E7E3E7"  LINK="#004080" VLINK="#004080" olink="#008080">
<table COLS="3" WIDTH="16%">
<tr>
<td>
<font face="Verdana" size="3">
<a href="Index1.html">
<img SRC="Back.gif" BORDER="0">
</a>
</font>
</td>
<td WIDTH="10%">
<font face="Verdana" size="3">
<a href="../index.html">
<img SRC="Menu.gif" BORDER="0">
</a>
</font>
</td>
<td ALIGN="RIGHT">
<font face="Verdana" size="3">
<a href="Index3.html">
<img SRC="For.gif" BORDER="0">
</a>
</font>
</td>
</tr>
</table>
<P><font face="Verdana" size="3">
&nbsp;
</font ></P>
<p align="center">
<font face="Verdana" size="3">
<font size="4">Интерфейс переноса Drag-and-Drop</font>
<br>
</font>
</P>
<p align="left">
 
<P><font face="Verdana" size="3"> Интерфейс переноса и приема компонентов появился 
  достаточно давно. Он обеспечивает взаимодействие двух элементов управления во 
  время выполнения приложения. При этом могут выполняться любые необходимые операции. 
  Несмотря на простоту реализации и давность разработки, многие программисты (особенно 
  новички) считают этот механизм малопонятным и экзотическим. Тем не менее использование 
  Drag-and-Drop может оказаться очень полезным и простым в реализации. Сейчас 
  мы в этом убедимся. </font ></P>
<P><font face="Verdana" size="3"> Для того чтобы механизм заработал, требуется 
  настроить соответствующим образом два элемента управления. Один должен быть 
  источником (Source), второй — приемником (Target). При этом источник никуда 
  не перемещается, а только регистрируется в качестве такового в механизме. </font ></P>
<P><font face="Verdana" size="3"> <B>Примечание&nbsp;</B> </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> Один элемент управления может быть одновременно 
    источником и приемником. </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Пользователь помещает указатель мыши на нужный 
  элемент управления, нажимает левую кнопку мыши и, не отпуская ее, начинает перемещать 
  курсор ко второму элементу. При достижении этого элемента пользователь отпускает 
  кнопку мыши. В этот момент выполняются предусмотренные разработчиком действия. 
  При этом первый элемент управления является источником, а второй — приемником. 
  </font ></P>
<P><font face="Verdana" size="3"> После выполнения настройки механизм включается 
  и реагирует на перетаскивание мышью компонента-источника в приемник. Группа 
  методов-обработчиков обеспечивает контроль всего процесса и служит для хранения 
  исходного кода, который разработчик сочтет нужным связать с перетаскиванием. 
  Это может быть передача текста, значений свойств (из одного редактора в другой 
  можно передать настройки интерфейса, шрифта и сам текст); перенос файлов и изображений; 
  простое перемещение элемента управления с места на место и т. д. Пример реализации 
  Drag-and-Drop в Windows — возможность переноса файлов и папок между дисками 
  и папками. </font ></P>
<P><font face="Verdana" size="3"> Как видите, можно придумать множество областей 
  применения механизма Drag-and-Drop. Его универсальность объясняется тем, что 
  это всего лишь средство связывания двух компонентов при помощи указателя мыши. 
  А конкретное наполнение зависит только от фантазии программиста и поставленных 
  задач. </font ></P>
<P><font face="Verdana" size="3"> Весь механизм Drag-and-Drop реализован в базовом 
  классе TControl, который является предком всех элементов управления. Рассмотрим 
  суть механизма. </font ></P>
<P><font face="Verdana" size="3"> Любой элемент управления из Палитры компонентов 
  Delphi является источником в механизме Drag-and-Drop. Его поведение на начальном 
  этапе переноса зависит от значения свойства </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> type TDragMode = (dmManual, dmAutomatic);&nbsp; 
    </font ></P>
  <P><font face="Verdana" size="3"> property DragMode: TDragMode; </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Значение dmAutomatic обеспечивает автоматическую 
  реакцию компонента на нажатие левой кнопки мыши и начало перетаскивания — при 
  этом механизм включается самостоятельно. </font ></P>
<P><font face="Verdana" size="3"> Значение dmManual (установлено по умолчанию) 
  требует от разработчика обеспечить включение механизма вручную. Этот режим используется 
  в том случае, если компонент должен реагировать на нажатие левой кнопки мыши 
  как-то иначе. Для инициализации переноса используется метод </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> procedure BeginDrag(Immediate: Boolean;&nbsp; 
    </font ></P>
  <P><font face="Verdana" size="3"> Threshold: Integer = -1); </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Параметр immediate = True обеспечивает немедленный 
  старт механизма. При значении False механизм включается только при перемещении 
  курсора на расстояние, определенное параметром Threshold. </font ></P>
<P><font face="Verdana" size="3"> О включении механизма сигнализирует указатель 
  мыши — он изменяется на курсор, определенный в свойстве </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> property DragCursor: TCursor; </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Еще раз напомним, что источник при перемещении 
  курсора не изменяет собственного положения, и только в случае успешного завершения 
  переноса сможет взаимодействовать с приемником. </font ></P>
<P><font face="Verdana" size="3"> Приемником может стать любой компонент, в котором 
  создан метод-обработчик </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> procedure DragOver(Source: TObject; X, Y: 
    Integer; State: TDragState;&nbsp; </font ></P>
  <P><font face="Verdana" size="3"> var Accept: Boolean); </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Он вызывается при перемещении курсора в режиме 
  Drag-and-Drop над этим компонентом. В методе-обработчике можно предусмотреть 
  селекцию источников переноса по нужным атрибутам. </font ></P>
<P><font face="Verdana" size="3"> Если параметр Accept получает значение True, 
  то данный компонент становится приемником. Источник переноса определяется параметром 
  source. Через этот параметр разработчик получает доступ к свойствам и методам 
  источника. Текущее положение курсора задают параметры X и Y. Параметр state 
  возвращает информацию о характере движения мыши: </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> type TDragState = (dsDragEnter, dsDragLeave, 
    dsDragMove); </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> dsDragEnter — указатель появился над компонентом; 
  dsDragLeave — указатель покинул компонент; dsDragMove — указатель перемещается 
  по компоненту. </font ></P>
<P><font face="Verdana" size="3"> Приемник должен предусматривать выполнение некоторых 
  действий в случае, если источник завершит перенос именно на нем. Для этого используется 
  метод-обработчик </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> type TDragDropEvent = procedure(Sender, Source: 
    TObject; X, Y: Integer) </font ></P>
  <P><font face="Verdana" size="3"> of object; </font ></P>
  <P><font face="Verdana" size="3"> property OnDragDrop: TDragDropEvent; </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> который вызывается при отпускании левой кнопки 
  мыши на компоненте-приемнике. Доступ к источнику и приемнику обеспечивают параметры 
  Source и Sender соответственно. Координаты мыши возвращают параметры X и Y. 
  </font ></P>
<P><font face="Verdana" size="3"> При завершении переноса элемент управления — 
  источник — получает соответствующее сообщение, которое обрабатывается методом 
  </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> type TEndDragEvent = procedure(Sender, Target: 
    TObject; X, Y: Integer) </font ></P>
  <P><font face="Verdana" size="3"> of object; </font ></P>
  <P><font face="Verdana" size="3"> property OnEndDrag: TEndDragEvent; </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Источник и приемник определяются параметрами 
  Sender и Target соответственно. Координаты мыши определяются параметрами X и 
  Y. </font ></P>
<P><font face="Verdana" size="3"> Для программной остановки переноса можно использовать 
  метод EndDrag источника (при обычном завершении операции пользователем он не 
  используется): </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> procedure EndDrag(Drop: Boolean); </font ></P>
  <P><font face="Verdana" size="3"> Параметр Drop = True завершает перенос. Значение 
    False прерывает перенос. </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Теперь настало время закрепить полученные знания 
  на практике. Рассмотрим небольшой пример. В проекте DemoDragDrop на основе механизма 
  Drag-and-Drop реализована передача текста между текстовыми редакторами и перемещение 
  панелей по форме (рис. 27.1). </font ></P>
<p align="center">
 
<div align="center"><font size="3" face="Verdana"><IMG src="gl.27.1.gif" > </font> 
</div>
<P align="center"> <font size="3" face="Verdana"><B>Рис. 27.1. </B>Главная форма 
  проекта DemoDragDrop </font></P>
<font size="3" face="Verdana"> 
<P align="center"><b>Листинг 27.1.</b> Секция implementation модуля главной формы 
  проекта DemoDragDrop </P>
</font> 
<blockquote> 
  <P><font face="Verdana" size="3"> implementation </font ></P>
  <P><font face="Verdana" size="3"> {$R *.DFM) </font ></P>
  <P><font face="Verdana" size="3"> procedure TMainForm.EditlMouseDown(Sender: 
    TObject; Button: TMouseButton; Shift: TShiftState; X, У: Integer); </font ></P>
  <P><font face="Verdana" size="3"> begin if Button = mbLeft </font ></P>
  <P><font face="Verdana" size="3"> then TEdit(Sender).BeginDrag(True);&nbsp; 
    </font ></P>
  <P><font face="Verdana" size="3"> end; </font ></P>
  <P><font face="Verdana" size="3"> procedure TMainForm.Edit2DragOver(Sender, 
    Source: TObject; X, Y: Integer; </font ></P>
  <P><font face="Verdana" size="3"> State: TDragState; var Accept: Boolean); </font ></P>
  <P><font face="Verdana" size="3"> &nbsp;begin </font ></P>
  <P><font face="Verdana" size="3"> &nbsp;if Source is TEdit </font ></P>
  <P><font face="Verdana" size="3"> then Accept := True </font ></P>
  <P><font face="Verdana" size="3"> else Accept :&lt;= False;&nbsp; </font ></P>
  <P><font face="Verdana" size="3"> end; </font ></P>
  <P><font face="Verdana" size="3"> procedure TMainForm.Edit2DragDrop(Sender, 
    Source: TObject; X, Y: </font ></P>
  <P><font face="Verdana" size="3"> Integer); </font ></P>
  <P><font face="Verdana" size="3"> begin </font ></P>
  <P><font face="Verdana" size="3"> TEdit(Sender).Text := TEdit(Source).Text; 
    </font ></P>
  <P><font face="Verdana" size="3"> TEdit(Sender).SetFocus; </font ></P>
  <P><font face="Verdana" size="3"> TEdit(Sender).SelectAll; </font ></P>
  <P><font face="Verdana" size="3"> &nbsp;end; </font ></P>
  <P><font face="Verdana" size="3"> procedure TMainForm.EditlEndDrag(Sender, Target: 
    TObject; X, Y: Integer);&nbsp; </font ></P>
  <P><font face="Verdana" size="3"> begin if Assigned(Target) </font ></P>
  <P><font face="Verdana" size="3"> then TEdit(Sender).Text := 'Текст перенесен 
    в ' + TEdit(Target).Name;&nbsp; </font ></P>
  <P><font face="Verdana" size="3"> end; </font ></P>
  <P><font face="Verdana" size="3"> procedure TMainForm.FormDragOver(Sender, Source: 
    TObject; X, Y: Integer; </font ></P>
  <P><font face="Verdana" size="3"> State: TDragState; var Accept: Boolean); begin 
    if Source.ClassName = 'TPanel' </font ></P>
  <P><font face="Verdana" size="3"> then Accept := True </font ></P>
  <P><font face="Verdana" size="3"> else Accept := False;&nbsp; </font ></P>
  <P><font face="Verdana" size="3"> end; </font ></P>
  <P><font face="Verdana" size="3"> procedure TMainForm.FormDragDrop(Sender, Source: 
    TObject; X, Y: Integer);&nbsp; </font ></P>
  <P><font face="Verdana" size="3"> begin </font ></P>
  <P><font face="Verdana" size="3"> TPanel(Source).Left := X; </font ></P>
  <P><font face="Verdana" size="3"> TPanel(Source).Top := Y; </font ></P>
  <P><font face="Verdana" size="3"> &nbsp;end; </font ></P>
  <P><font face="Verdana" size="3"> end. </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Для однострочного редактора Edit1 определены 
  методы-обработчики источника. В методе EditiMouseDown обрабатывается нажатие 
  левой кнопки мыши </font ></P>
<P><font face="Verdana" size="3"> и включается механизм переноса. Так как свойство 
  DragMode для Edit1 имеет значение dmManual, то компонент без проблем обеспечивает 
  получение фокуса и редактирование текста. </font ></P>
<P><font face="Verdana" size="3"> Метод EditiEndDrag обеспечивает отображение 
  информации о выполнении переноса в источнике. </font ></P>
<P><font face="Verdana" size="3"> Для компонента Edit2 определены методы-обработчики 
  приемника. Метод Edit2DragOver проверяет класс источника и разрешает или запрещает 
  прием. </font ></P>
<P><font face="Verdana" size="3"> Метод Edit2DragDrop осуществляет перенос текста 
  из источника в приемник. </font ></P>
<P><font face="Verdana" size="3"> <B> Примечание</B> </font ></P>
<blockquote> 
  <P><font face="Verdana" size="3"> Обратите внимание, что оба компонента TEdit 
    одновременно являются источниками и приемниками. Для этого каждый из них использует 
    методы-обработчики другого. А исходный код методов настроен на обработку владельца 
    как экземпляра класса TEdit. </font ></P>
</blockquote>
<P><font face="Verdana" size="3"> Форма, как приемник Drag-and-Drop, обеспечивает 
  перемещение панели Panel2, которая выступает в роли источника. Метод FormDragOver 
  запрещает прием любых компонентов, кроме панелей. Метод FormDragDrop осуществляет 
  перемещение компонента. </font ></P>
<P><font face="Verdana" size="3"> Панель не имеет своих методов-обработчиков, 
  т. к. работает в режиме dmAutomatic и не нуждается в дополнительной обработке 
  завершения переноса. </font ></P>
<P><font face="Verdana" size="3"> &nbsp; </font ></P>
<table COLS="3" WIDTH="16%">
  <tr> 
    <td> <font face="Verdana" size="3"> <a href="Index1.html"> <img SRC="Back.gif" BORDER="0"> 
      </a> </font> </td>
    <td WIDTH="10%"> <font face="Verdana" size="3"> <a href="../index.html"> <img SRC="Menu.gif" BORDER="0"> 
      </a> </font> </td>
    <td ALIGN="RIGHT"> <font face="Verdana" size="3"> <a href="Index3.html"> <img SRC="For.gif" BORDER="0"> 
      </a> </font> </td>
  </tr>
</table>
</body>
</html>
