<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<title>
</title>
<meta http-equiv="Content-Type" content="text/html;charset=windows-1251">
</head>
<body TEXT="#000000" BGCOLOR="#E7E3E7"  LINK="#004080" VLINK="#004080" olink="#008080">
<table COLS="3" WIDTH="16%">
<tr>
<td>
<font face="Verdana" size="3">
<a href="Index18.html">
<img SRC="Back.gif" BORDER="0">
</a>
</font>
</td>
<td WIDTH="10%">
<font face="Verdana" size="3">
<a href="../index.html">
<img SRC="Menu.gif" BORDER="0">
</a>
</font>
</td>
<td ALIGN="RIGHT">
<font face="Verdana" size="3">
<a href="Index20.html">
<img SRC="For.gif" BORDER="0">
</a>
</font>
</td>
</tr>
</table>
<P><font face="Verdana" size="3">
&nbsp;
</font ></P>
<p align="center"> <font face="Verdana" size="3"> <strong>Оповещение 
  об изменении в файловой системе</strong> <br>
</font>
</P>
<p align="left">
<font face="Verdana" size="3">

</font ></P>
<P><font face="Verdana" size="3">
Этот вид объекта ожидания очень интересен и незаслуженно мало известен. Мы рассмотрели практически все варианты того, как один поток может подать сигнал другому. А как получить сигнал от операционной системы? Ну, например, о том, что в файловой системе произошли какие-то изменения? Такой вид оповещения позаимствован из ОС UNIX и доступен программистам, работающим с Win32. Для организации мониторинга файловой системы нужно использовать
</font ></P>
<P><font face="Verdana" size="3">
Три функции — <font face="Verdana" size="2"> FindFirstChangeNotification, FindNextChangeNotification
и FinddoseChangeNotification</font>. Первая из них возвращает дескриптор объекта файлового оповещения, который можно передать в функцию ожидания. Объект активизируется тогда, когда в заданной папке произошли те или
иные изменения (создание или уничтожение файла или папки, изменение прав доступа и т. д.). Вторая — готовит объект к реакции на следующее изменение. Наконец, с помощью третьей функции следует закрыть ставший ненужным объект.
</font ></P>
<P><font face="Verdana" size="3">
Так может выглядеть код метода <font face="Verdana" size="2"> Execute</font> потока, созданного для мониторинга файловой системы:
</font ></P>
<blockquote>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
var DirName : string;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">...</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
procedure TSimpleThread.Execute;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> var r: Cardinal;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
fn : THandle;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
fn := FindFirstChangeNotification(pChar(DirName), True,</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
FILEJTOTIFY_CHANGE_FILE_NAME);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
repeat</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
r := WaitForSingleObject(fn,2000);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
if r = WAIT_OBOECT_0 then</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
Synchronize(Forml.UpdateList);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
if not FindNextChangeNotification(fn) then</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;break;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;until Terminated;&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">FindCloseChangeNotification(fn);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp; end;</font>
</font ></P>
</blockquote>
<P><font face="Verdana" size="3">
На главной форме должны находиться компоненты, нужные для выбора обследуемой папки, а также компонент
<font face="Verdana" size="2">TListBox</font>, в который будут записываться имена файлов:
</font ></P>
<blockquote>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
procedure TForml.ButtonlClick(Sender: TObject);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;var dir : string; begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
if SelectDirectory(dir,[],0)&nbsp;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2"> then begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
Editl.Text := dir; DirName := dir;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;end;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp; end;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
procedure TForml.UpdateList;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;var SearchRec: TSearchRec;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">&nbsp;begin</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
ListBoxl.Clear;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
FindFirst(Editl.Text+'\*.*', faAnyFile, SearchRec); repeat ListBoxl.Items.Add(SearchRec.Name);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">
until FindNext(SearchRec) &lt;&gt; 0;</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">FindClose(SearchRec);</font>
</font ></P>
<P><font face="Verdana" size="3">
<font face="Verdana" size="2">end;</font>
</font ></P>
</blockquote>
<P><font face="Verdana" size="3">
Приложение готово. Чтобы оно стало полнофункциональным, предусмотрите в нем механизм перезапуска потока при изменении обследуемой папки.
</font ></P>
<P><font face="Verdana" size="3">
&nbsp;
</font ></P>
<table COLS="3" WIDTH="16%">
<tr>
<td>
<font face="Verdana" size="3">
<a href="Index18.html">
<img SRC="Back.gif" BORDER="0">
</a>
</font>
</td>
<td WIDTH="10%">
<font face="Verdana" size="3">
<a href="../index.html">
<img SRC="Menu.gif" BORDER="0">
</a>
</font>
</td>
<td ALIGN="RIGHT">
<font face="Verdana" size="3">
<a href="Index20.html">
<img SRC="For.gif" BORDER="0">
</a>
</font>
</td>
</tr>
</table>
</body>
</html>